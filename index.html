<!doctype html>
<html>
    <head>
        <title>Flickr Image Search</title>
        <link rel="stylesheet" href="styles/primer.min.css">
        <link rel="stylesheet" href="styles/main.css">
    </head>
    <body>

    <div class="columns">
        <div class="one-half column centered">

            <form class="search js-weatherapi">
                <div class="search__block">
                    <input class="input-block js-search" type="text" placeholder="eg. nyc, usa">
                </div>
                <div class="form-actions">
                  <button type="button" class="btn btn-primary js-submit">Search</button>
                  <button type="button" class="btn js-reset">Reset</button>
                </div>
            </form>

            <div class="columns" id="photos"></div>
        </div>
    </div>
        <script>
          function alb(searchHandler, modal, onSubmit, onClear, showModal) {
            function revealImageModal( e ) {
              var $clickedImage = $(e.currentTarget).find('img');
              showModal($clickedImage);
            }

            $('#photos').on('click', '.weather-factory-item', revealImageModal);
          }

          function sjackson44(searchHandler, modal, onSubmit, onClear, showModal) {
            $('.weather-factory-item').click( function(e) {
              e.preventDefault();
              showModal();
            });
          }

          function cheshireoctopus(searchHandler, modal, onSubmit, onClear, showModal) {
            $(document).on('click', '.weather-factory-item', function(ev) {
                var $img = $(ev.currentTarget);
                showModal($img);
            });
          }

          //window.run_solution = alb;
          //window.run_solution = cheshireoctopus;
          window.run_solution = sjackson44;
        </script>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script src="js/WeatherAPIFactory.js"></script>
        <script src="js/FlickrAPIFactory.js"></script>
        <script src="js/ModalFactory.js"></script>
        <script src="js/WeatherTaggedPhotosFactory.js"></script>
        <script src="js/app.js"></script>

        <script>
          /*
          every search will clear the images from the page and repopulate with new search results
          you must write a click handler that must run ONCE when page loads
          this click handler should call the showModal function (already implemented) which will display a modal.
          you must NOT edit any code area aside from app.js (but feel free to read through the other included JS files -- hopefully it will be educational and/or informative).
          */
          $(function runFunctionalTests() {
            var $input = $('.input-block.js-search'),
                $btn   = $('.btn.btn-primary.js-submit'),
                $photo = $('#photos'),
                didrun = false,
                again  = false,
                passed = false,
                pass2  = false,
                effiency_score;

            function testPassed() {
              if (again) {
                pass2  = true;
              } else {
                passed = true;
              }

              console.log('test passed');
              testCleanup();
            }

            function testFailed() {
              console.log('test failed');
              testCleanup();
            }

            function testCleanup() {
              $('.modal__close').click();
              if (!again) {
                $('.js-reset').click();
                $('#photos').html();
                window.search_id++;
                again = true;
                didrun = false;
                $input.val('usa').change();
                $btn.click();
              } else {
                checkEffiency();
              }
            }

            function checkEffiency() {
              console.log('pass: ', passed, 'pass2: ', pass2);
              var search = 'click for .weather-factory-item';
              var report = $(document).eventReport().split('\n\n'),
                  st = -1; // -1=fail, 1=great, 0 okay

              if (report[0].indexOf(search) > -1) {
                console.log('put event handler on body: only okay!');
                st = 0;
              } else {
                $.each(report, function (i, v) {
                  if (v.indexOf('#photos') > -1) {
                    if (v.indexOf(search) > -1) {
                      console.log('put event handler on photos! perfect!');
                      st = 1;
                    }
                  } else if (v.indexOf(search) > -1) {
                    console.log('put event handler somewhere only okay.');
                    st = 0;
                  }
                });
              }

              effiency_score = st === -1 ? 0 : (st === 1 ? 1 : .5);
              console.log('effiency: ', effiency_score);
            }

            window.search_id = 0;

            window.notify_test = function ($img, batch) {
              if (didrun) { return; }
              if (batch != window.search_id) { return; }
              didrun = true;
              $img.click();

              var $modal = $('.modal'),
                  $content = $('.modal__content');

              if ($modal.hasClass('modal--showing')) {
                if ($('img', $content).length === 1) {
                  // showing one and only one image
                  return testPassed();
                }
              }

              testFailed();
            };

    $.eventReport = function(selector, root) {
        var s = [];
        $(selector || '*', root).addBack().each(function() {
            // the following line is the only change
            var e = $._data(this, 'events');
            if(!e) return;
            s.push(this.tagName);
            if(this.id) s.push('#', this.id);
            if(this.className) s.push('.', this.className.replace(/ +/g, '.'));
            for(var p in e) {
                var r = e[p],
                    h = r.length - r.delegateCount;
                if(h)
                    s.push('\n', h, ' ', p, ' handler', h > 1 ? 's' : '');
                if(r.delegateCount) {
                    for(var q = 0; q < r.length; q++)
                        if(r[q].selector) s.push('\n', p, ' for ', r[q].selector);
                }
            }
            s.push('\n\n');
        });
        return s.join('');
    }

    $.fn.eventReport = function(selector) {
        return $.eventReport(selector, this);
    };

            $input.val('nyc').change();
            $btn.click();
          });
        </script>
    </body>
</html>
